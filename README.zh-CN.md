# 简化编译器（Flex / Bison / IR / NASM）

本项目实现了一个**简化但完整的编译器**。项目以类 C 风格的伪代码作为输入，按照编译器的典型流程，逐步完成词法分析、语法分析、抽象语法树（AST）构建、中间表示（IR）生成与优化，并最终生成 **NASM 汇编代码**。生成的汇编文件可以被汇编并链接为可执行程序，是本项目的最终产物。

本项目的目标不是实现一门工业级语言，而是通过一个可运行的完整流程，加深对编译器整体结构、控制流翻译以及基本优化技术的理解。

---

## 功能概述

* 使用 **Flex** 实现词法分析
* 使用 **Bison** 实现语法分析并处理运算符优先级
* 构建抽象语法树（AST）并支持结构打印
* 基于三地址码风格的中间表示（IR）生成
* 实现多种 IR 级别的简单优化（常量折叠、不可达代码删除等）
* 将 IR 翻译为 **NASM 汇编代码（最终产物）**
* 生成的汇编程序可以成功编译并执行

---

## 项目结构

```text
Task04_BisonParser_IR/
├── .github/
│   └── workflows/
│       └── ci.yml
├── include/
│   ├── ast.hpp        # 抽象语法树节点定义
│   ├── codegen.hpp    # 汇编代码生成接口与声明
│   ├── ir.hpp         # 中间表示（IR）定义
│   └── tokens.hpp     # 词法与语法分析使用的 Token 定义
├── src/
│   ├── codegen.cpp    # IR → NASM 汇编代码生成实现
│   ├── ir.cpp         # IR 生成与优化实现
│   └── main.cpp       # 编译器入口
├── parser.yy          # Bison 语法规则文件
├── scanner.l          # Flex 词法规则文件
├── CMakeLists.txt     # CMake 构建配置
├── read.txt           # 示例输入程序
├── expected.txt       # 参考输出
├── .gitignore
├── output.asm         # 生成的 NASM 汇编代码（产物）
├── output.o           # 汇编后的目标文件（产物）
└── program            # 最终可执行文件（产物）
```

> 说明：`cmake-build-debug/` 为本地构建目录，由 IDE 自动生成，不属于项目源码结构。

---

## 编译流程说明

整个编译过程按照以下阶段依次进行：

1. **词法分析**
   使用 Flex 将源代码的字符流转换为 Token 流，支持标识符、关键字、整数与字符串常量、运算符以及多种注释形式。

2. **语法分析**
   使用 Bison 根据文法规则对 Token 流进行分析，并在语法动作中构建抽象语法树（AST）。运算符的优先级和结合性通过 Bison 声明进行控制。

3. **抽象语法树（AST）构建与检查**
   AST 用于表示程序的层次结构。项目中通过深度优先遍历（DFS）方式打印 AST，以验证语法结构的正确性。在该阶段对字符串相关节点进行了单独设计，以正确支持字符串赋值与拼接。

4. **中间表示（IR）生成与优化**
   AST 被转换为线性的 IR 指令序列，采用三地址码风格。IR 包含赋值、比较、条件跳转、无条件跳转、标签以及打印等指令。在此基础上实现了多种简单优化，包括：

    * 常量折叠
    * 常量条件判断与控制流简化
    * 不可达代码删除
    * 临时变量消除
    * 无用赋值删除
    * 冗余跳转与未使用标签清理

5. **汇编代码生成**
   优化后的 IR 被翻译为 NASM 汇编代码，生成 `.asm` 文件。该文件包含数据段、BSS 段与代码段，并按需生成整数与字符串输出的辅助函数。生成的汇编代码可以被成功汇编并链接为可执行程序，是本项目的最终输出结果。

---

## 构建与运行

### 构建项目

```bash
mkdir build
cd build
cmake ..
make
```

### 运行编译器

```bash
./compiler read.txt
```

### 汇编并执行生成结果

```bash
nasm -f elf64 output.asm -o output.o
gcc output.o -o program
./program
```


